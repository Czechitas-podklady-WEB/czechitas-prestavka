<!DOCTYPE html>
<html lang="cs" theme="dark">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Czechitas přestávka</title>
		<meta
			name="description"
			content="Nástroj pro vytváření přestávkových slidů."
		/>
		<meta name="color-scheme" content="light dark" />
		<meta
			name="theme-color"
			media="(prefers-color-scheme: light)"
			content="white"
		/>
		<meta
			name="theme-color"
			media="(prefers-color-scheme: dark)"
			content="black"
		/>
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta
			property="og:image"
			content="https://prestavka.czechitas-podklady.cz/og-image.jpg"
		/>
		<link rel="shortcut icon" href="icon.png" />
		<link
			href="library/materialize-v2.0.3-alpha/materialize/css/materialize.min.css"
			rel="stylesheet"
			type="text/css"
		/>
		<script>
			const media = window.matchMedia('(prefers-color-scheme: dark)')
			const updateAttribute = () => {
				document.documentElement.setAttribute(
					'theme',
					media.matches ? 'dark' : 'light',
				)
			}
			updateAttribute()
			media.addEventListener('change', updateAttribute)
		</script>
		<script src="library/materialize-v2.0.3-alpha/materialize/js/materialize.min.js"></script>
		<link
			href="https://fonts.googleapis.com/icon?family=Material+Icons"
			rel="stylesheet"
		/>
		<style>
			body {
				padding-block: 5rem;
			}
			#settings_link-show[href=''],
			#settings_link-control[href=''] {
				visibility: hidden;
			}
			.logo {
				max-width: 1em;
				height: auto;
				margin-bottom: -0.15em;
			}
			.configuator ~ .slide {
				display: none;
			}
			.slide {
				position: fixed;
				inset: 0;
				background-color: #000000;
				display: grid;
				align-items: center;
				justify-items: center;
			}
			.slide_in {
				position: relative;
				aspect-ratio: 16 / 9;
				width: min(100%, calc(16 / 9 * 100vh));
				width: min(100%, calc(16 / 9 * 100svh));
			}
			.slide .background {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
				border: none;
			}
			.slide .countdown {
				visibility: hidden;
			}
			.slide .countdown_text {
				position: absolute;
				inset: 62% auto auto 0.3%;
				width: 37.9%;
				height: 29.9%;
				color: #ffffff;
				text-align: center;
				font-feature-settings: 'tnum';
				font-variant-numeric: tabular-nums;
				font-family: Open Sans, sans-serif;
				--base: 11.4;
				font-size: 11.4vw; /* OBS fallback */
				font-size: calc(1vw * var(--base));
			}
			@media (min-aspect-ratio: 16 / 9) {
				.slide .countdown_text {
					font-size: calc(1vh * var(--base) * 16 / 9);
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="configuator">
				<h1>
					<img src="icon.png" alt="" width="512" height="512" class="logo" />
					Czechitas přestávka
				</h1>
				<h5 class="mt-6 mb-5">Nastavte si vlastní přestávkový slide:</h5>
				<form class="controls row" style="gap: 5px; align-items: center">
					<div class="col s12">
						<div class="input-field">
							<input
								id="identificator"
								type="text"
								autocomplete="off"
								autofocus
								name="id"
								value="czechitas-javascript-1"
							/>
							<label for="identificator">Identifikátor</label>
						</div>
					</div>
					<div class="col s12 center-align">
						<div class="settings">
							<a
								href=""
								class="waves-effect waves-light btn"
								id="settings_link-show"
								><i class="material-icons left">visibility</i> Zobrazit
								odpočet</a
							>
							<a
								href=""
								class="waves-effect waves-light btn"
								id="settings_link-control"
								><i class="material-icons left">settings</i> Ovládat odpočet</a
							>
						</div>
					</div>
				</form>
				<h5 class="mt-6 mb-5">Nebo použijte už předchystaný:</h5>
				<div class="collection">
					<a class="collection-item" href="?seconds=60">1 minuta</a>
					<a class="collection-item" href="?seconds=120">2 minuty</a>
					<a class="collection-item" href="?seconds=300">5 minut</a>
					<a class="collection-item" href="?seconds=420">7 minut</a>
					<a class="collection-item" href="?seconds=600">10 minut</a>
					<a class="collection-item" href="?seconds=900">15 minut</a>
					<a class="collection-item" href="?seconds=1200">20 minut</a>
					<a class="collection-item" href="?seconds=1800">30 minut</a>
					<a class="collection-item" href="?seconds=2700">45 minut</a>
					<a class="collection-item" href="?seconds=3600">60 minut (1 hodina)</a
					><a class="collection-item" href="?seconds=3600"
						>120 minut (2 hodiny)</a
					>
					<div class="collection-item">
						<form class="row" style="gap: 5px; align-items: center">
							<div class="col s4">
								<div class="input-field">
									<input
										id="seconds"
										name="seconds"
										type="number"
										step="1"
										min="1"
									/>
									<label for="seconds">Vlastní [s]</label>
								</div>
							</div>
							<div class="col s8">
								<button
									type="submit"
									class="waves-effect waves-light btn-large"
								>
									<i class="material-icons left">visibility</i> Spustit
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
			<div class="slide">
				<div class="slide_in">
					<iframe
						class="background"
						src="https://intro.czechitas-podklady.cz/slide.html?title=P%C5%99est%C3%A1vka"
					></iframe>
					<iframe
						class="countdown"
						src="https://just-countdown.eu/screen?id=break"
						allowtransparency
					></iframe>
					<div class="countdown_text"></div>
				</div>
			</div>
		</div>

		<script>
			const urlIdentificator = (identificator) =>
				`${encodeURIComponent(identificator)}`
			const urlParameters = new URLSearchParams(window.location.search)
			const identificator = urlParameters.get('id')
			const seconds = (() => {
				const number = parseInt(urlParameters.get('seconds') ?? '')
				if (Number.isNaN(number) || number <= 0) {
					return null
				}
				return number
			})()
			const configuator = document.querySelector('.configuator')

			const showIframe = (path) => {
				configuator.remove()
				const countdown = document.querySelector('.countdown')
				const countdownText = document.querySelector('.countdown_text')
				const url = new URL(`https://just-countdown.eu${path}`)
				countdown.src = url.toString()

				window.addEventListener('message', (event) => {
					if (
						event.origin === url.origin &&
						typeof event.data.formattedTime === 'string'
					) {
						const minutes = Math.floor(event.data.remainingTimeInSeconds / 60)
						const seconds = event.data.remainingTimeInSeconds % 60
						countdownText.textContent = `${minutes
							.toString()
							.padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
					}
				})
			}

			if (identificator) {
				showIframe(`/screen?id=${urlIdentificator(identificator)}`)
			} else if (seconds) {
				showIframe(`/run?seconds=${seconds}`)
			} else {
				const identificatorInput = document.querySelector('#identificator')
				identificatorInput.value =
					localStorage.getItem('identificator') ?? identificatorInput.value

				const handleChange = () => {
					const identificator = identificatorInput.value
					const settingsLinkShow = document.querySelector('#settings_link-show')
					const settingsLinkControl = document.querySelector(
						'#settings_link-control',
					)
					localStorage.setItem('identificator', identificator)
					settingsLinkShow.href = identificator
						? `?id=${urlIdentificator(identificator)}`
						: ''
					settingsLinkControl.href = identificator
						? `https://just-countdown.eu/control?id=${urlIdentificator(
								identificator,
						  )}`
						: ''
				}
				handleChange()

				identificatorInput.addEventListener('input', handleChange)
			}
		</script>
	</body>
</html>
